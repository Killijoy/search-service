# Search service


Сервис, предоставляющий функционал полнотекстового поиска по заголовкам и контенту постов
с использованием русской и английской морфологии и вывода топа поисковых запросов.

## Как это работает

Все посты из основной БД индексируются поисковым сервером Sphinx.

Индексируется текст из заголовка и контента поста (если он есть)
с атрибутами (регион, категория, источник, время публикации) для фильтрации и сортировки. Индекс состоит из 2 частей:
main-индекс (основной) и delta-index (новые посты). Раз в неделю происходит полная переиндексация основного индекса. Delta-индекс переиндексируется каждые 5-минут, при этом происходит мердж данных в основной индекс.

При старте Sphinx-сервера происходит парсинг query-log для наполнения статистики
запросов (если есть такая необходимость). Также, счетчики статистики инкрементируются при обработке поискового запроса.

При поисковом запросе в сервис происходит нормализация ключевой фразы - в строке остаются только алфавитно-цифровые
символы, пробелы и дефис.

Затем выполняется запрос ID постов из Sphinx, удовлетворяющих условиям. Максимальное количество постов контролируется
параметром `max_matches`, задаваемым в настройках приложения (чем больше этот параметр, тем дольше поиск
  и больше нагрузка на сервер).

Все полученные и обработанные посты складываются в кеш запроса и хранятся там заданное количество
времени (по умолчанию - 5 минут). Это необходимо для быстрой пагинации, однако начальный запрос (запрос первой страницы)
может быть долгим.

## API
### /search
Полнотекстовый поиск по заголовкам и контенту постов с фильтрацией по региону, категории и источнику.
Посты упорядочены по дате публикации в источнике. Результат выводится постанично.

GET-параметры запроса:
* `q` - обязательный параметр - поисковая (ключевая) фраза.
Перед поиском будет нормализована (остаются только алфавитно-цифровые символы и пробелы).
* `region` - регион источника. Двухбуквенный код: `ru`, `us` и т.д.
* `category` - ID категории источника;
* `feed` - ID источника;
* `highlight` - имя css-класса для подсветки совпадений - `<span class="<highlight value>">...<span>`.
По умолчанию - пусто - подсветка тегами `<b>...</b>`.
* `page` - номер текущей страницы, по умолчанию - `1`;
* `size` - размер страницы (кол-во постов), по умолчанию - `20`;

Все GET-параметры необязательны, кроме параметра `q`.

> **Примечание:**
>
> Передавать в запрос одновременно `region`, `category` и/или `feed`  - бессмысленно.
Если источник/категория в каталоге указанного региона, то в выборку попадут посты только из
указанного источника/категории.
А если регион источника/категории отличается от указанного региона - в выборку ничего не попадет.

Вернет `400 Bad Request`, если:
* обязательный параметр `q`: не задан, имеет пустое значение после нормализации, короче 3 символов после нормализации;
* в параметре `region` передан код неподдерживаемого региона;
* значение параметра `category`: меньше `1` или не может быть преобразовано к целому числу;
* значение параметра `feed`: меньше `1` или не может быть преобразовано к целому числу;
* значение параметра `page` или `size` меньше `1`, или не может быть преобразовано к целому числу, или запрошена несуществующая страница.

Вернет `404 Not Found`, если:
* если ничего не найдено для ключевой фразы с переданными параметрами.

Вернет `503 Service Unavailable`, если:
* недоступен поисковый движок или кеш.

Возвращает `200 Ok` и JSON-объект с данными.

`GET /search?q=тест-драйв&feed=10473&size=5&highlight=foo`
```
{
    "count": 8,               // Общее количество найденных постов
    "next": 2,                // Номер следующей страницы
    "previous": null,         // Номер пердыдущей страницы
    "last": 2,                // Номер последней страницы
    "size": 5,                // Размер страницы
    "results": [              // Результаты поиска - массив объектов постов
        {
            "id": 86566241,
            "fid": 10473,
            "ts": 1519643968,
            "title": "<span class=\"foo\">Тест</span>-<span class=\"foo\">драйв</span> Datsun on-DO 16V. Допинг полезными порциями",
            "summary": "Это самый значительный апгрейд российских моделей Datsun за все время их существования. Седан on-DO и хэтчбек mi-DO получили более прогрессивный и мощный 16-клапанный мотор, причем доплата - всего 15 000 рублей.",
            "img": "//img.test.com/media/posts/images/20180226/86566241_v1.jpg",
            "content": " ...  мотор, и седан поедет с огоньком. По итогам <span class=\"foo\">теста</span> в смешанном режиме борткомпьютер показал 5,8 л/100 ... ",
            "author": "Алина Фомичева"
        },
        // ...
    ]
}
```

### /top
Топ-запросов (что ищут пользователи).

GET-параметры запроса:
* `count` - сколько запросов показать (опционально). По умолчанию - `100`.

Вернет `400 Bad Request`, если:
* параметр `count` меньше `1`;
* параметр `count` не может быть преобразован в целое число.

Вернет `404 Not Found`, если:
* В статистике пусто, то есть у сервиса еще ничего не спрашивали
(может быть при очистке БД статистики).

Вернет `503 Service Unavailable`, если:
* БД статистики не отвечает.

Возвращает `200 Ok` и JSON-объект с данными.

`GET /top?count=3`:
```
{
    "count": 3,                               // Количество ключевых фраз в топе
    "queries": [                              // Данные о запросах
        {
            "query": "выходные дни 2018",     // Ключевая фраза
            "count": 46                       // Статистика запросов
        },
        {
            "query": "мстители",
            "count": 11
        },
        {
            "query": "putin",
            "count": 11
        }
    ]
}
```

### /\_health
Хэлсчек сервиса - показывает состояние приложения по состоянию зависимостей.

Возвращает `200 Ok` и JSON-объект с данными.

`GET /_health`:
```
{
    "status": "UP",                     // Общее состояние сервиса
    "index": {                          // Информация об индексах Sphinx
        "status": "UP",                 // Состояние
        "details": {                    // Метрика. Если сервис в состоянии DOWN, здесь строка с описанием ошибки
            "ping": 0.0003008842,       // Время ответа
            "meta": {                   // Дополнительная информация об индексах
                "main": {               // Основной индекс
                    // ...
                },
                "delta": {              // Индекс свежих постов
                    // ...
                }
            }
        }
    },
    "db": {                             // БД, необходимая для работы (Redis)
        "status": "UP",                 // Состояние
        "details": {                    // Метрика. Если сервис в состоянии DOWN, здесь строка с описанием ошибки
            "ping": 0.0013155937,       // Время ответа
            "stats_count": 11,          // Количество запросов в статистике
            "cache_count": 0,           // Количество закешированных запросов
            "meta": {                   // Дополнительная информация
                // ...
            }
        }
    },
    "bus": {                            // Post Bus
        "status": "UP",                 // Состояние
        "details": {                    // Метрика. Если сервис в состоянии DOWN, здесь строка с описанием ошибки
            "ping": 0.035187006,        // Время ответа
            "meta": {                   // Дополнительная информация
                // ...
            }
        }
    }
}
```


## Стек
* [Sphinx](http://sphinxsearch.com/) - движок полнотекстового поиска (по протоколу `mysql`)
* [Redis](https://redis.io/) - хранение статистики и кеша запросов
* Python 3.6: [gunicorn](http://gunicorn.org/) + [falcon](https://falconframework.org/) + [meinheld](http://meinheld.org/)


## Docker

Возможна работа сервиса со Sphinx, запущенным как в контейнере, так и на хосте.

Сборка образа для Sphinx:

    $ docker build -t git.test.com:4567/test/backend/search-service/sphinx ./sphinx

Сборка образа для приложения:

    $ docker build -f ./app/Dockerfile.test -t git.test.com:4567/test/backend/search-service ./app

Конфигурация контейнеров через env-файлы:
- `app-example.env` - пример конфигурации приложения
- `sphinx-example.env` - пример конфигурации Sphinx

В файле `docker-compose-example.yml` - пример конфигурации для запуска контейнеров.

## Переменные окружения

Общие переменные окружения, которые **должны иметь одинаковое значение** как для приложения, так и для Sphinx.

#### REDIS_URL
Строка URL для соединения с сервером Redis. Задается в [формате](http://redis-py.readthedocs.io/en/latest/index.html?highlight=from_url#redis.ConnectionPool.from_url):

    REDIS_URL=redis://<host>:<port>/<database_number>

#### STATS_KEY
Ключ, по которому хранится статистика запросов. По умолчанию:

    STATS_KEY=queries

### Приложение
Специфичные для приложения переменные окружения.

#### SPHINX_HOST
Адрес хоста, на котором запущен сервер Sphinx:

    SPHINX_HOST=127.0.0.1

#### SPHINX_MAX_MATCHES
Ограничение на количество совпадений при поиске.

    SPHINX_MAX_MATCHES=3000

#### CACHE_TTL
Время жизни результатов поиска в кэше в секундах (по умолчанию 5 минут):

    CACHE_TTL=300

#### REGIONS
Список поддерживаемых регионов. Задается через запятую без пробелов:

    REGIONS=ru,us,ua,br,fr,se

#### LOG_DIR
Путь к директории с логами приложения:

    LOG_DIR=/var/log/search

#### SENTRY
DSN-строка для логирования ошибок в Sentry. Значение для [dev](http://0a7886c0fcda4e70b14d5c2f18b26daf:5dc98e3be6514a75904df8c44a562b1a@sentry.test.com/24) и [prod](#).

    SENTRY=http://0a7886c0fcda4e70b14d5c2f18b26daf:5dc98e3be6514a75904df8c44a562b1a@sentry.test.com/24

### Sphinx
Переменные окружения для запуска сервера Sphinx.

#### SPHINX_CONFIG_PATH
Путь к файлу конфига Sphinx:

    SPHINX_CONFIG_PATH=/etc/sphinxsearch/sphinxy.conf

#### SPHINX_LOG_DIR
Путь к директории для логов Sphinx (searchd):

    SPHINX_LOG_DIR=/var/log/sphinxsearch

#### MYSQL_URL
Строка URL для соединения с сервером MySQL для индексатора. Задается в формате:

    MYSQL_URL=mysql://<user>:<password>@<host>:<port>/<db>

> **Примечание:**
>
> Также возможно задать параметры соединения в отдельных переменных:
`MYSQL_HOST`, `MYSQL_PORT`, `MYSQL_DB`, `MYSQL_USER`, `MYSQL_PASSWORD`.